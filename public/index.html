<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hideout Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1> Hideout Chat </h1>

  <!-- Mode Selection -->
  <div id="mode-selection">
    <h2>Choose Chat Mode</h2>
    <button onclick="joinMode('random')">ðŸ”€ Random Chat</button>
    <button onclick="joinMode('room')">ðŸ”’ Room Chat</button>
    <button onclick="joinMode('interest')">ðŸŽ¯ Interest-based Chat</button>
  </div>

  <!-- Chat UI -->
  <div id="chat-container">
    <button id="back-btn" style="display:none;">â¬… Back to Menu</button>

    <div id="room-selection" style="display:none;">
      <input id="room" placeholder="Enter room code">
      <button id="join-room-btn">Join Room</button>
    </div>

    <div id="interest-selection" style="display:none;">
      <select id="interest">
        <option value="science">Science</option>
        <option value="horror">Horror</option>
        <option value="comedy">Comedy</option>
      </select>
      <button id="join-interest-btn">Join</button>
    </div>

    <ul id="messages"></ul>
    <p id="typing"></p>

    <form id="form">
      <input id="input" autocomplete="off" placeholder="Type a message..." />
      <button>Send</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let nickname = "";
    let avatar = "";

    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const messages = document.getElementById("messages");
    const typing = document.getElementById("typing");

    const backBtn = document.getElementById("back-btn");

    // Receive nickname & avatar
    socket.on("welcome", (data) => {
      nickname = data.nickname;
      avatar = data.avatar;
    });

    // Mode selection
    function joinMode(mode) {
      document.getElementById("mode-selection").style.display = "none";
      document.getElementById("chat-container").style.display = "block";
      backBtn.style.display = "inline-block";

      if (mode === "room") {
        document.getElementById("room-selection").style.display = "block";
      } else if (mode === "interest") {
        document.getElementById("interest-selection").style.display = "block";
      } else {
        socket.emit("joinMode", "random");
      }
    }

    // Back button
    backBtn.onclick = () => {
      document.getElementById("mode-selection").style.display = "block";
      document.getElementById("chat-container").style.display = "none";
      document.getElementById("room-selection").style.display = "none";
      document.getElementById("interest-selection").style.display = "none";
      messages.innerHTML = "";
    };

    // Join room
    document.getElementById("join-room-btn").onclick = () => {
      const room = document.getElementById("room").value || "room123";
      socket.emit("joinMode", "room", room);
    };

    // Join interest
    document.getElementById("join-interest-btn").onclick = () => {
      const interest = document.getElementById("interest").value;
      socket.emit("joinMode", "interest", interest);
    };

    // Send message
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      if (input.value) {
        socket.emit("chat message", input.value);
        input.value = "";
        socket.emit("stopTyping");
      }
    });

    // Typing indicator
    input.addEventListener("input", () => {
      if (input.value) {
        socket.emit("typing");
      } else {
        socket.emit("stopTyping");
      }
    });

    // Display messages
    socket.on("chat message", (data) => {
      const li = document.createElement("li");

      if (data.avatar) {
        const avatarImg = document.createElement("img");
        avatarImg.src = data.avatar;
        li.appendChild(avatarImg);
      }

      const text = document.createTextNode(`${data.nickname}: ${data.msg}`);
      li.appendChild(text);
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    });

    // Typing indicator
    socket.on("typing", (name) => {
      typing.textContent = `${name} is typing...`;
    });

    socket.on("stopTyping", () => {
      typing.textContent = "";
    });
  </script>
</body>
</html>
