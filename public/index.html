<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title> Hideout Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1> Hideout Chat </h1>

  <!-- MAIN MODE SELECTION -->
  <div id="mode-selection">
    <h2>Select Chat Mode</h2>
    <button onclick="joinMode('random')">🔀 Random Group Chat</button>
    <button onclick="joinMode('room')">🔒 Room Chat</button>
    <button onclick="joinMode('interest')">🎯 Interest Chat</button>
    <button onclick="joinMode('1v1')">🤝 1 vs 1 Chat</button>
  </div>

  <!-- WAITING ROOM FOR 1v1 MODE -->
  <div id="waiting-container">
    <h2>🤝 Waiting for a partner...</h2>
    <div id="avatar-slideshow"></div>
  </div>

  <!-- CHAT CONTAINER -->
  <div id="chat-container">
    <button id="back-btn" style="display:none;">⬅ Back to Menu</button>

    <!-- ROOM SELECTION -->
    <div id="room-selection" style="display:none;">
      <input id="room" placeholder="Enter room code">
      <button id="join-room-btn">Join Room</button>
    </div>

    <!-- INTEREST SELECTION -->
    <div id="interest-selection" style="display:none;">
      <select id="interest">
        <option value="science">🔬 Science</option>
        <option value="horror">👻 Horror</option>
        <option value="comedy">😂 Comedy</option>
      </select>
      <button id="join-interest-btn">Join</button>
    </div>

    <!-- CHAT MESSAGES -->
    <ul id="messages"></ul>
    <p id="typing"></p>

    <!-- MESSAGE INPUT -->
    <form id="form">
      <input id="input" autocomplete="off" placeholder="Type a message..." />
      <button>Send</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let nickname = "";
    let avatar = "";
    let isWaiting = false;

    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const messages = document.getElementById("messages");
    const typing = document.getElementById("typing");
    const backBtn = document.getElementById("back-btn");

    socket.on("welcome", (data) => {
      nickname = data.nickname;
      avatar = data.avatar;
    });

    function joinMode(mode) {
      document.getElementById("mode-selection").style.display = "none";
      backBtn.style.display = "inline-block";

      if (mode === "room") {
        document.getElementById("room-selection").style.display = "block";
      } else if (mode === "interest") {
        document.getElementById("interest-selection").style.display = "block";
      } else if (mode === "1v1") {
        document.getElementById("waiting-container").style.display = "flex";
        isWaiting = true;
        socket.emit("joinMode", "1v1");

        const avatarContainer = document.getElementById("avatar-slideshow");
        avatarContainer.innerHTML = "";
        for (let i = 1; i <= 6; i++) {
          const img = document.createElement("img");
          img.src = `/avatars/avatar${i}.png`;
          avatarContainer.appendChild(img);
        }
      } else {
        document.getElementById("chat-container").style.display = "block";
        socket.emit("joinMode", mode);
      }
    }

    document.getElementById("join-room-btn").onclick = () => {
      const room = document.getElementById("room").value || "room123";
      socket.emit("joinMode", "room", room);
      document.getElementById("chat-container").style.display = "block";
    };

    document.getElementById("join-interest-btn").onclick = () => {
      const interest = document.getElementById("interest").value;
      socket.emit("joinMode", "interest", interest);
      document.getElementById("chat-container").style.display = "block";
    };

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      if (input.value) {
        socket.emit("chat message", input.value);
        input.value = "";
        socket.emit("stopTyping");
      }
    });

    input.addEventListener("input", () => {
      if (input.value) {
        socket.emit("typing");
      } else {
        socket.emit("stopTyping");
      }
    });

    socket.on("chat message", (data) => {
      if (isWaiting && data.nickname !== "System") {
        document.getElementById("waiting-container").style.display = "none";
        document.getElementById("chat-container").style.display = "block";
        isWaiting = false;
      }

      const li = document.createElement("li");
      if (data.avatar) {
        const avatarImg = document.createElement("img");
        avatarImg.src = data.avatar;
        li.appendChild(avatarImg);
      }
      li.appendChild(document.createTextNode(`${data.nickname}: ${data.msg}`));
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on("typing", (name) => {
      typing.textContent = `${name} is typing...`;
    });

    socket.on("stopTyping", () => {
      typing.textContent = "";
    });

    backBtn.onclick = () => {
      if (isWaiting) {
        socket.emit("leave1v1");
      }
      socket.disconnect();
      location.reload();
    };
  </script>
</body>
</html>
