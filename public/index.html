<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hideout Chat - 18+ Community</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Floating particles -->
  <div class="particles-container"></div>

  <!-- Age Verification Modal -->
  <div id="age-verification-modal" class="modal-overlay">
    <div class="modal-content age-verification">
      <div class="modal-header">
        <i class="fas fa-shield-alt"></i>
        <h2>Age Verification Required</h2>
      </div>
      <div class="modal-body">
        <p class="age-warning">This chat platform is intended for users 18 years and older.</p>
        <p class="age-question">Are you 18 years of age or older?</p>
        <div class="age-buttons">
          <button class="age-btn confirm-btn" onclick="confirmAge(true)">
            <i class="fas fa-check"></i> Yes, I am 18+
          </button>
          <button class="age-btn deny-btn" onclick="confirmAge(false)">
            <i class="fas fa-times"></i> No, I am under 18
          </button>
        </div>
        <p class="age-disclaimer">
          By clicking "Yes", you confirm that you are at least 18 years old and agree to our terms of service.
        </p>
      </div>
    </div>
  </div>

  <!-- Captcha Verification Modal -->
  <div id="captcha-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content captcha-verification">
      <div class="modal-header">
        <i class="fas fa-robot"></i>
        <h2>Verify You're Human</h2>
      </div>
      <div class="modal-body">
        <p class="captcha-instruction">Please solve this simple math problem to continue:</p>
        <div class="captcha-container">
          <div class="captcha-question" id="captcha-question">
            Loading...
          </div>
          <div class="captcha-input-group">
            <input type="number" id="captcha-answer" placeholder="Your answer" autocomplete="off" />
            <button class="captcha-submit" onclick="submitCaptcha()">
              <i class="fas fa-check"></i>
            </button>
          </div>
        </div>
        <button class="captcha-refresh" onclick="refreshCaptcha()">
          <i class="fas fa-refresh"></i> New Question
        </button>
        <div class="captcha-error" id="captcha-error" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Under Age Restriction -->
  <div id="underage-restriction" class="modal-overlay" style="display: none;">
    <div class="modal-content underage-content">
      <div class="modal-header">
        <i class="fas fa-exclamation-triangle"></i>
        <h2>Access Restricted</h2>
      </div>
      <div class="modal-body">
        <div class="restriction-icon">
          <i class="fas fa-ban"></i>
        </div>
        <h3>Sorry, you must be 18 or older to use this service.</h3>
        <p>This chat platform is designed for adult users only. Please come back when you're 18!</p>
        <div class="restriction-links">
          <a href="https://www.commonsensemedia.org/" target="_blank">
            <i class="fas fa-external-link-alt"></i> Find Age-Appropriate Chat Platforms
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Content -->
  <div id="main-app" style="display: none;">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-comments"></i>
        Hideout Chat
        <span class="age-badge">18+</span>
      </div>
      <div class="user-info" style="display: none;">
        <img class="user-avatar" src="#" alt="Avatar">
        <span class="user-name">Anonymous</span>
        <div class="online-indicator">
          <i class="fas fa-circle"></i>
        </div>
      </div>
    </div>

    <!-- Mode Selection -->
    <div id="mode-selection">
      <div class="welcome-text">
        <h1>Welcome to Hideout</h1>
        <p>Connect with adults worldwide. Choose your chat experience and start meaningful conversations.</p>
        <div class="server-stats" id="server-stats">
          <span class="stat-item">
            <i class="fas fa-users"></i>
            <span id="online-count">0</span> online
          </span>
          <span class="stat-item">
            <i class="fas fa-comments"></i>
            <span id="rooms-count">0</span> active rooms
          </span>
        </div>
      </div>
      
      <div class="mode-buttons">
        <div class="mode-card" onclick="joinMode('random')">
          <div class="mode-icon">
            <i class="fas fa-random"></i>
          </div>
          <div class="mode-title">Random Chat</div>
          <div class="mode-description">
            Connect with random people worldwide. Perfect for spontaneous conversations and meeting new friends.
          </div>
        </div>
        
        <div class="mode-card" onclick="joinMode('room')">
          <div class="mode-icon">
            <i class="fas fa-door-open"></i>
          </div>
          <div class="mode-title">Private Room</div>
          <div class="mode-description">
            Create or join a private room with a custom code. Great for chatting with friends or small groups.
          </div>
        </div>
        
        <div class="mode-card" onclick="joinMode('interest')">
          <div class="mode-icon">
            <i class="fas fa-heart"></i>
          </div>
          <div class="mode-title">Interest Based</div>
          <div class="mode-description">
            Find people who share your interests. Connect based on topics you're passionate about.
          </div>
        </div>

        <div class="mode-card" onclick="joinMode('1v1')">
          <div class="mode-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="mode-title">1 vs 1 Chat</div>
          <div class="mode-description">
            Get paired with one person for private conversation. Perfect for making new connections one-on-one.
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>Made with <i class="fas fa-heart"></i> for connecting adults worldwide</p>
        <div class="footer-links">
          <a href="#" onclick="showTerms()">Terms of Service</a> |
          <a href="#" onclick="showPrivacy()">Privacy Policy</a> |
          <a href="#" onclick="showGuidelines()">Community Guidelines</a>
        </div>
      </div>
    </div>

    <!-- Waiting Screen for 1v1 Mode -->
    <div id="waiting-container" style="display: none;">
      <div class="waiting-header">
        <button class="back-btn" id="waiting-back-btn">
          <i class="fas fa-arrow-left"></i> Back to Menu
        </button>
        <div class="waiting-info">
          <span id="queue-status">Looking for a partner...</span>
        </div>
      </div>
      
      <div class="waiting-content">
        <div class="waiting-animation">
          <div class="avatar-slideshow">
            <div class="avatar-slide active">
              <div class="waiting-avatar-placeholder">
                <i class="fas fa-user"></i>
              </div>
            </div>
            <div class="avatar-slide">
              <div class="waiting-avatar-placeholder">
                <i class="fas fa-user-friends"></i>
              </div>
            </div>
            <div class="avatar-slide">
              <div class="waiting-avatar-placeholder">
                <i class="fas fa-comments"></i>
              </div>
            </div>
          </div>
          
          <div class="waiting-text">
            <h2>Finding your chat partner...</h2>
            <p id="queue-message">Searching for someone to chat with</p>
            <div class="waiting-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
        
        <div class="queue-stats">
          <div class="stat-item">
            <i class="fas fa-clock"></i>
            <span>Queue Position: <span id="queue-position">-</span></span>
          </div>
          <div class="stat-item">
            <i class="fas fa-users"></i>
            <span>People waiting: <span id="people-waiting">-</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Container -->
    <div id="chat-container">
      <div class="chat-header">
        <button class="back-btn" id="back-btn">
          <i class="fas fa-arrow-left"></i> Back to Menu
        </button>
        <div class="room-info">
          <span id="room-name">Loading...</span>
          <span class="online-count" id="online-count">
            <i class="fas fa-users"></i> <span id="user-count">0</span> online
          </span>
        </div>
      </div>

      <!-- Join Forms -->
      <div id="room-selection" class="join-form">
        <div class="form-header">
          <i class="fas fa-door-open"></i>
          <h3>Join Private Room</h3>
        </div>
        <div class="form-content">
          <input id="room" placeholder="Enter room code (e.g., party2024)" maxlength="20">
          <button class="join-btn" id="join-room-btn">
            <i class="fas fa-sign-in-alt"></i> Join Room
          </button>
        </div>
      </div>

      <div id="interest-selection" class="join-form">
        <div class="form-header">
          <i class="fas fa-heart"></i>
          <h3>Choose Your Interest</h3>
        </div>
        <div class="form-content">
          <select id="interest">
            <option value="general">💬 General Discussion</option>
            <option value="technology">💻 Technology & Programming</option>
            <option value="gaming">🎮 Gaming</option>
            <option value="music">🎵 Music</option>
            <option value="movies">🎬 Movies & TV Shows</option>
            <option value="sports">⚽ Sports</option>
            <option value="art">🎨 Art & Design</option>
            <option value="food">🍕 Food & Cooking</option>
            <option value="travel">✈️ Travel & Adventure</option>
            <option value="books">📚 Books & Literature</option>
            <option value="fitness">💪 Fitness & Health</option>
            <option value="business">💼 Business & Career</option>
            <option value="relationships">💕 Relationships & Dating</option>
            <option value="philosophy">🤔 Philosophy & Deep Thoughts</option>
          </select>
          <button class="join-btn" id="join-interest-btn">
            <i class="fas fa-heart"></i> Find My Community
          </button>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-container">
        <ul id="messages"></ul>
        <div id="typing"></div>
      </div>

      <!-- Message Input -->
      <div class="message-input-container">
        <form id="form">
          <div class="input-wrapper">
            <input id="input" autocomplete="off" placeholder="Type your message..." maxlength="500" />
            <div class="char-counter">
              <span id="char-count">0</span>/500
            </div>
          </div>
          <button type="submit" class="send-btn" id="send-btn">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="connection-status" id="connection-status">
    <i class="fas fa-wifi"></i> Connected
  </div>

  <!-- Notification Container -->
  <div class="notification-container" id="notification-container"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Connecting...</p>
    </div>
  </div>

  <!-- Scripts -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Global variables
    let socket;
    let nickname = "";
    let avatar = "";
    let currentRoom = "";
    let isTyping = false;
    let currentPartner = null;
    let waitingInterval;
    let slideInterval;
    let currentCaptcha = null;

    // DOM elements
    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const messages = document.getElementById("messages");
    const typing = document.getElementById("typing");
    const backBtn = document.getElementById("back-btn");
    const userInfo = document.querySelector('.user-info');
    const userAvatar = document.querySelector('.user-avatar');
    const userName = document.querySelector('.user-name');
    const roomName = document.getElementById('room-name');
    const userCount = document.getElementById('user-count');
    const charCount = document.getElementById('char-count');
    const connectionStatus = document.getElementById('connection-status');
    const sendBtn = document.getElementById('send-btn');

    let typingTimer;
    let typingUsers = new Set();

    // ===== AGE VERIFICATION =====
    
    function confirmAge(isAdult) {
      if (isAdult) {
        // Store age verification in localStorage for 24 hours
        const verification = {
          verified: true,
          timestamp: Date.now(),
          expires: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
        };
        localStorage.setItem('ageVerified', JSON.stringify(verification));
        
        // Hide age verification and show captcha
        document.getElementById('age-verification-modal').style.display = 'none';
        showCaptchaVerification();
      } else {
        // Show underage restriction
        document.getElementById('age-verification-modal').style.display = 'none';
        document.getElementById('underage-restriction').style.display = 'flex';
      }
    }

    function checkAgeVerification() {
      const stored = localStorage.getItem('ageVerified');
      if (stored) {
        try {
          const verification = JSON.parse(stored);
          if (verification.verified && Date.now() < verification.expires) {
            // Already verified and not expired, show captcha
            document.getElementById('age-verification-modal').style.display = 'none';
            showCaptchaVerification();
            return true;
          }
        } catch (e) {
          // Invalid stored data, clear it
          localStorage.removeItem('ageVerified');
        }
      }
      
      // Show age verification modal
      document.getElementById('age-verification-modal').style.display = 'flex';
      return false;
    }

    // ===== CAPTCHA VERIFICATION =====
    
    async function showCaptchaVerification() {
      document.getElementById('captcha-modal').style.display = 'flex';
      await refreshCaptcha();
    }

    async function refreshCaptcha() {
      try {
        const response = await fetch('/generate-captcha');
        const captcha = await response.json();
        
        currentCaptcha = captcha;
        document.getElementById('captcha-question').textContent = `What is ${captcha.question}?`;
        document.getElementById('captcha-answer').value = '';
        document.getElementById('captcha-error').style.display = 'none';
        
        // Focus on input
        document.getElementById('captcha-answer').focus();
      } catch (error) {
        console.error('Failed to generate captcha:', error);
        document.getElementById('captcha-question').textContent = 'Error loading captcha';
      }
    }

    async function submitCaptcha() {
      const answer = document.getElementById('captcha-answer').value;
      const errorDiv = document.getElementById('captcha-error');
      
      if (!answer) {
        showCaptchaError('Please enter an answer');
        return;
      }

      if (!currentCaptcha) {
        showCaptchaError('Please refresh the captcha');
        return;
      }

      try {
        const response = await fetch('/verify-captcha', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            captchaId: currentCaptcha.id,
            answer: parseInt(answer)
          })
        });

        const result = await response.json();
        
        if (result.success) {
          // Captcha verified successfully
          document.getElementById('captcha-modal').style.display = 'none';
          initializeApp();
        } else {
          showCaptchaError(result.message || 'Incorrect answer. Please try again.');
          await refreshCaptcha();
        }
      } catch (error) {
        console.error('Captcha verification failed:', error);
        showCaptchaError('Verification failed. Please try again.');
      }
    }

    function showCaptchaError(message) {
      const errorDiv = document.getElementById('captcha-error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      
      // Shake the captcha container
      const container = document.querySelector('.captcha-container');
      container.classList.add('shake');
      setTimeout(() => container.classList.remove('shake'), 600);
    }

    // Handle Enter key in captcha input
    document.getElementById('captcha-answer').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        submitCaptcha();
      }
    });

    // ===== APP INITIALIZATION =====
    
    function initializeApp() {
      // Show main app
      document.getElementById('main-app').style.display = 'block';
      
      // Initialize particles
      createParticles();
      
      // Initialize socket connection
      initializeSocket();
      
      // Load server stats
      loadServerStats();
      
      console.log('🚀 Hideout Chat App initialized');
    }

    function createParticles() {
      const particlesContainer = document.querySelector('.particles-container');
      if (!particlesContainer) return;
      
      for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    async function loadServerStats() {
      try {
        const response = await fetch('/health');
        const stats = await response.json();
        
        document.getElementById('online-count').textContent = stats.connections || 0;
        document.getElementById('rooms-count').textContent = stats.rooms?.totalRooms || 0;
      } catch (error) {
        console.error('Failed to load server stats:', error);
      }
    }

    // ===== SOCKET CONNECTION =====
    
    function initializeSocket() {
      socket = io({
        transports: ['websocket', 'polling'],
        upgrade: true,
        rememberUpgrade: true
      });

      // Connection handlers
      socket.on('connect', () => {
        connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Connected';
        connectionStatus.className = 'connection-status connected';
      });

      socket.on('disconnect', () => {
        connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Disconnected';
        connectionStatus.className = 'connection-status disconnected';
        showNotification('Connection lost. Attempting to reconnect...', 'error');
      });

      socket.on('reconnect', () => {
        showNotification('Reconnected successfully!', 'success');
      });

      // Welcome event
      socket.on("welcome", (data) => {
        nickname = data.nickname;
        avatar = data.avatar;
        userName.textContent = nickname;
        userAvatar.src = data.avatar;
        userInfo.style.display = 'flex';
        showNotification(`Welcome, ${nickname}!`, 'success');
      });

      // Room updates
      socket.on("roomUpdate", (data) => {
        userCount.textContent = data.userCount;
      });

      // Message handling
      socket.on("chat message", (data) => {
        displayMessage(data);
      });

      // Typing indicators
      socket.on("typing", (name) => {
        typingUsers.add(name);
        updateTypingIndicator();
      });

      socket.on("stopTyping", (name) => {
        typingUsers.delete(name);
        updateTypingIndicator();
      });

      // 1v1 events
      socket.on("queueStatus", (data) => {
        document.getElementById("queue-position").textContent = data.position;
        document.getElementById("queue-status").textContent = data.message;
        document.getElementById("people-waiting").textContent = data.position;
      });

      socket.on("matched", (data) => {
        currentPartner = data;
        hideWaitingScreen();
        
        document.getElementById("chat-container").style.display = "flex";
        document.getElementById("chat-container").classList.remove("show-form");
        roomName.textContent = `1v1 with ${data.partnerName}`;
        currentRoom = data.roomId;
        
        messages.innerHTML = "";
        showNotification(`You've been matched with ${data.partnerName}!`, 'success');
        
        setTimeout(() => {
          if (input) input.focus();
        }, 300);
      });

      socket.on("partnerDisconnected", (data) => {
        showNotification(`${data.partnerName} has disconnected. Finding you a new partner...`, 'info');
        
        document.getElementById("chat-container").style.display = "none";
        showWaitingScreen();
        currentPartner = null;
        currentRoom = "";
      });

      // Rate limiting
      socket.on('rate_limit', (message) => {
        showNotification(message, 'warning');
        
        if (input) {
          input.disabled = true;
          sendBtn.disabled = true;
          
          setTimeout(() => {
            input.disabled = false;
            sendBtn.disabled = false;
          }, 10000);
        }
      });

      socket.on('message_error', (message) => {
        showNotification(message, 'error');
      });

      socket.on('pong', () => {
        // Connection is alive
      });
    }

    // ===== UTILITY FUNCTIONS =====
    
    function showNotification(message, type = 'info') {
      const notificationContainer = document.getElementById('notification-container');
      if (!notificationContainer) return;
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      notificationContainer.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (e) {
        // Sound not available
      }
    }

    // ===== MESSAGE HANDLING =====
    
    function displayMessage(data) {
      if (!messages) return;
      
      const li = document.createElement("li");
      
      if (data.type === "system") {
        li.className = "system-message";
        li.innerHTML = `<i class="fas fa-info-circle"></i> ${data.msg}`;
      } else {
        li.className = "message-item";
        
        const avatar = document.createElement("img");
        avatar.className = "message-avatar";
        avatar.src = data.avatar;
        avatar.alt = data.nickname;
        avatar.onerror = () => {
          // Create a simple colored avatar if image fails
          const initials = data.nickname.substring(0, 2).toUpperCase();
          const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
          const color = colors[Math.abs(data.nickname.split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % colors.length];
          
          avatar.style.display = 'none';
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'message-avatar avatar-placeholder';
          avatarDiv.style.backgroundColor = color;
          avatarDiv.textContent = initials;
          avatar.parentNode.insertBefore(avatarDiv, avatar);
        };
        
        const content = document.createElement("div");
        content.className = "message-content";
        
        const header = document.createElement("div");
        header.className = "message-header";
        
        const author = document.createElement("span");
        author.className = "message-author";
        author.textContent = data.nickname;
        
        const time = document.createElement("span");
        time.className = "message-time";
        time.textContent = new Date(data.timestamp || Date.now()).toLocaleTimeString([], {
          hour: '2-digit', 
          minute: '2-digit'
        });
        
        const text = document.createElement("div");
        text.className = "message-text";
        text.textContent = data.msg;
        
        header.appendChild(author);
        header.appendChild(time);
        content.appendChild(header);
        content.appendChild(text);
        li.appendChild(avatar);
        li.appendChild(content);
      }
      
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
      
      // Add glow effect for new messages
      li.classList.add('glow');
      setTimeout(() => li.classList.remove('glow'), 2000);
      
      // Play sound effect for other users' messages
      if (data.nickname !== nickname) {
        playNotificationSound();
      }

      // Limit messages to prevent memory issues
      if (messages.children.length > 100) {
        messages.removeChild(messages.firstChild);
      }
    }

    function updateTypingIndicator() {
      if (!typing) return;
      
      if (typingUsers.size === 0) {
        typing.innerHTML = "";
        return;
      }
      
      const names = Array.from(typingUsers);
      let text = "";
      
      if (names.length === 1) {
        text = `${names[0]} is typing`;
      } else if (names.length === 2) {
        text = `${names[0]} and ${names[1]} are typing`;
      } else {
        text = `${names.slice(0, -1).join(', ')} and ${names[names.length - 1]} are typing`;
      }
      
      typing.innerHTML = `
        <div class="typing-animation">
          <span>${text}</span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      `;
    }

    // ===== MODE SELECTION AND NAVIGATION =====
    
    function joinMode(mode) {
      document.getElementById("mode-selection").style.display = "none";

      if (mode === "1v1") {
        showWaitingScreen();
        socket.emit("join1v1");
      } else {
        document.getElementById("chat-container").style.display = "flex";
        backBtn.style.display = "inline-block";

        if (mode === "room") {
          document.getElementById("chat-container").classList.add("show-form");
          document.getElementById("room-selection").style.display = "block";
          roomName.textContent = "Private Room";
        } else if (mode === "interest") {
          document.getElementById("chat-container").classList.add("show-form");
          document.getElementById("interest-selection").style.display = "block";
          roomName.textContent = "Interest Chat";
        } else if (mode === "random") {
          document.getElementById("chat-container").classList.remove("show-form");
          socket.emit("joinMode", "random");
          roomName.textContent = "Random Chat";
          currentRoom = "random";
          setTimeout(() => input?.focus(), 100);
        }
      }
    }

    function showWaitingScreen() {
      document.getElementById("waiting-container").style.display = "flex";
      startAvatarSlideshow();
      startWaitingAnimation();
    }

    function hideWaitingScreen() {
      document.getElementById("waiting-container").style.display = "none";
      stopAvatarSlideshow();
      stopWaitingAnimation();
    }

    function startAvatarSlideshow() {
      const slides = document.querySelectorAll('.avatar-slide');
      let currentSlide = 0;
      
      slideInterval = setInterval(() => {
        slides[currentSlide].classList.remove('active');
        currentSlide = (currentSlide + 1) % slides.length;
        slides[currentSlide].classList.add('active');
      }, 2000);
    }

    function stopAvatarSlideshow() {
      if (slideInterval) {
        clearInterval(slideInterval);
      }
    }

    function startWaitingAnimation() {
      const messages = [
        "Searching for someone to chat with...",
        "Looking for your perfect match...",
        "Finding an interesting person...",
        "Almost there, hang tight...",
        "Connecting you with someone new..."
      ];
      
      let messageIndex = 0;
      const messageElement = document.getElementById('queue-message');
      
      waitingInterval = setInterval(() => {
        if (messageElement) {
          messageElement.textContent = messages[messageIndex];
          messageIndex = (messageIndex + 1) % messages.length;
        }
      }, 3000);
    }

    function stopWaitingAnimation() {
      if (waitingInterval) {
        clearInterval(waitingInterval);
      }
    }

    // ===== FORM HANDLERS =====
    
    // Room joining
    document.getElementById("join-room-btn").onclick = () => {
      const roomInput = document.getElementById("room");
      const room = roomInput.value.trim();
      
      if (!room) {
        showNotification('Please enter a room code', 'error');
        return;
      }
      if (room.length < 3) {
        showNotification('Room code must be at least 3 characters', 'error');
        return;
      }
      
      document.getElementById("room-selection").style.display = "none";
      document.getElementById("chat-container").classList.remove("show-form");
      
      socket.emit("joinMode", "room", room);
      roomName.textContent = `Room: ${room}`;
      currentRoom = room;
      
      messages.innerHTML = "";
      showNotification(`Joined room: ${room}`, 'success');
      setTimeout(() => input?.focus(), 100);
    };

    // Interest joining
    document.getElementById("join-interest-btn").onclick = () => {
      const interestSelect = document.getElementById("interest");
      const interest = interestSelect.value;
      const interestText = interestSelect.selectedOptions[0].text;
      
      document.getElementById("interest-selection").style.display = "none";
      document.getElementById("chat-container").classList.remove("show-form");
      
      socket.emit("joinMode", "interest", interest);
      roomName.textContent = interestText;
      currentRoom = interest;
      
      messages.innerHTML = "";
      showNotification(`Joined ${interestText}`, 'success');
      setTimeout(() => input?.focus(), 100);
    };

    // Back buttons
    backBtn.onclick = () => {
      const isInForm = document.getElementById("chat-container").classList.contains("show-form");
      
      if (isInForm) {
        resetChatContainer();
        document.getElementById("chat-container").style.display = "none";
        document.getElementById("mode-selection").style.display = "block";
      } else {
        const message = currentPartner 
          ? 'Are you sure you want to leave this 1v1 chat?' 
          : 'Are you sure you want to leave the chat?';
          
        if (confirm(message)) {
          if (currentPartner) {
            socket.emit("leave1v1");
          }
          
          resetChatContainer();
          socket.disconnect();
          setTimeout(() => location.reload(), 100);
        }
      }
    };

    document.getElementById("waiting-back-btn").onclick = () => {
      if (confirm('Are you sure you want to stop looking for a chat partner?')) {
        socket.emit("leave1v1");
        hideWaitingScreen();
        document.getElementById("mode-selection").style.display = "block";
      }
    };

    function resetChatContainer() {
      document.getElementById("room-selection").style.display = "none";
      document.getElementById("interest-selection").style.display = "none";
      document.getElementById("chat-container").classList.remove("show-form");
      
      const roomInput = document.getElementById("room");
      const interestSelect = document.getElementById("interest");
      if (roomInput) roomInput.value = "";
      if (interestSelect) interestSelect.selectedIndex = 0;
      
      if (messages) messages.innerHTML = "";
      currentRoom = "";
      currentPartner = null;
    }

    // ===== MESSAGE SENDING =====
    
    if (form) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = input.value.trim();
        if (message && message.length <= 500) {
          socket.emit("chat message", message);
          input.value = "";
          charCount.textContent = "0";
          sendBtn.classList.remove('active');
          socket.emit("stopTyping");
          clearTimeout(typingTimer);
          isTyping = false;
        }
      });
    }

    // Character counter and typing
    if (input && charCount) {
      input.addEventListener('input', () => {
        charCount.textContent = input.value.length;
        
        if (input.value.trim().length > 0) {
          sendBtn.classList.add('active');
        } else {
          sendBtn.classList.remove('active');
        }

        // Typing indicator
        if (input.value.trim() && !isTyping) {
          socket.emit("typing");
          isTyping = true;
        }
        
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          socket.emit("stopTyping");
          isTyping = false;
        }, 2000);
        
        if (!input.value.trim() && isTyping) {
          socket.emit("stopTyping");
          isTyping = false;
        }
      });
    }

    // Room input validation
    const roomInput = document.getElementById("room");
    const joinRoomBtn = document.getElementById("join-room-btn");
    if (roomInput && joinRoomBtn) {
      joinRoomBtn.disabled = true;
      joinRoomBtn.style.opacity = "0.6";
      
      roomInput.addEventListener('input', (e) => {
        if (e.target.value.trim().length >= 3) {
          joinRoomBtn.disabled = false;
          joinRoomBtn.style.opacity = "1";
        } else {
          joinRoomBtn.disabled = true;
          joinRoomBtn.style.opacity = "0.6";
        }
      });
    }

    // ===== KEYBOARD SHORTCUTS =====
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const chatContainer = document.getElementById("chat-container");
        const waitingContainer = document.getElementById("waiting-container");
        
        const isInForm = chatContainer && chatContainer.classList.contains("show-form");
        const isInWaiting = waitingContainer && waitingContainer.style.display === "flex";
        const isInChat = chatContainer && chatContainer.style.display === "flex" && !isInForm;
        
        if (isInForm) {
          resetChatContainer();
          chatContainer.style.display = "none";
          document.getElementById("mode-selection").style.display = "block";
        } else if (isInWaiting) {
          document.getElementById("waiting-back-btn").click();
        } else if (isInChat) {
          backBtn.click();
        }
      }
      
      if (e.key === 'Enter' && roomInput && document.activeElement === roomInput && roomInput.value.trim()) {
        joinRoomBtn.click();
      }
    });

    // ===== HEARTBEAT =====
    
    setInterval(() => {
      if (socket && socket.connected) {
        socket.emit('ping');
      }
    }, 30000);

    // ===== FOOTER FUNCTIONS =====
    
    function showTerms() {
      alert('Terms of Service:\n\n1. Users must be 18 or older\n2. No harassment or inappropriate content\n3. Respect other users\n4. No spamming or advertising\n5. Follow community guidelines\n\nBy using this service, you agree to these terms.');
    }

    function showPrivacy() {
      alert('Privacy Policy:\n\n- We do not store your personal information\n- Messages are not permanently saved\n- We use cookies for session management\n- Your IP address is logged for security\n- We do not share data with third parties');
    }

    function showGuidelines() {
      alert('Community Guidelines:\n\n- Be respectful to all users\n- No hate speech or discrimination\n- No sharing of personal information\n- No inappropriate content\n- Report problematic users\n- Keep conversations friendly and appropriate');
    }

    // ===== INITIALIZATION ON PAGE LOAD =====
    
    document.addEventListener('DOMContentLoaded', () => {
      // Check age verification on page load
      checkAgeVerification();
      
      // Prevent zoom on mobile
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (event) => {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      // Set viewport height for mobile
      function setVH() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      setVH();
      window.addEventListener('resize', setVH);
    });

    // Global error handling
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      showNotification('Something went wrong. Please refresh if issues persist.', 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled promise rejection:', e.reason);
    });

    console.log('🚀 Hideout Chat initialized with age verification and bot protection');
  </script>
</body>
</html>